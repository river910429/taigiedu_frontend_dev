name: Auto Sync and Deploy

on:
  # æ¯ 15 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '*/15 * * * *'
  # è®“ä½ ç¾åœ¨å¯ä»¥æ‰‹å‹•æŒ‰æŒ‰éˆ•æ¸¬è©¦
  workflow_dispatch:

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. åˆ‡æ›åˆ° develop åˆ†æ”¯
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: develop
          fetch-depth: 0
          # â†“â†“â†“ å‘Šè¨´å®ƒä¸è¦å„²å­˜é è¨­ Tokenï¼Œé€™æ¨£æˆ‘å€‘å¾Œé¢æ‰èƒ½è‡ªå·±ç”¨ Token
          persist-credentials: false

      # 2. è¨­å®š Git èº«åˆ†
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      # 3. å»æŠ“åŸå§‹ä½œè€…çš„æ›´æ–° (Sync) - é€™éƒ¨åˆ†ä¿æŒä¸è®Š
      - name: Sync from Upstream
        run: |
          # 1. æ‰‹å‹•å¹« origin è£ä¸Šä½ çš„è¬èƒ½ Token
          git remote set-url origin https://oauth2:${{ secrets.SYNC_TOKEN }}@github.com/river910429/taigiedu_frontend_dev.git
          
          # 2. è¨­å®š Upstream (å‰ç«¯åŸå§‹å°ˆæ¡ˆ)
          git remote add upstream https://oauth2:${{ secrets.SYNC_TOKEN }}@github.com/Taigiedu/taiwaneseOMG.git
          
          git fetch upstream
          
          UPSTREAM_HASH=$(git rev-parse upstream/develop)
          LOCAL_HASH=$(git rev-parse HEAD)
          
          if [ "$UPSTREAM_HASH" = "$LOCAL_HASH" ]; then
            echo "æ²’æœ‰æ–°ç‰ˆæœ¬ï¼Œè·³ééƒ¨ç½²ã€‚"
            echo "HAS_UPDATE=false" >> $GITHUB_ENV
          else
            echo "ç™¼ç¾æ–°ç‰ˆæœ¬ï¼æº–å‚™åŒæ­¥..."
            git reset --hard upstream/develop
            
            # é€™è£¡ç›´æ¥ push
            git push origin develop --force
            echo "HAS_UPDATE=true" >> $GITHUB_ENV
          fi

      # 4. åªæœ‰åœ¨æœ‰æ›´æ–° (æˆ–æ˜¯æ‰‹å‹•è§¸ç™¼) æ™‚æ‰æ‰“åŒ…éƒ¨ç½²
      - name: Setup Node.js
        if: env.HAS_UPDATE == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install and Build
        if: env.HAS_UPDATE == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          npm install
          
          # --- ğŸ”¥ è‡ªå‹•ç”¢ç”Ÿä¼ºæœå™¨å°ˆç”¨çš„ .env æª”æ¡ˆ ---
          
          # 1. Base Path (è·ŸåŸå§‹ä¸€æ¨£è¨­ç‚ºæ ¹ç›®éŒ„)
          echo "VITE_BASE_PATH=/" > .env
          
          # 2. API URL (é—œéµä¿®æ”¹ï¼)
          # ä½¿ç”¨ç›¸å°è·¯å¾‘ '/api'ï¼Œè®“ Nginx çš„ location /api/ å¹«æˆ‘å€‘è½‰ç™¼
          # é€™æ¨£ç„¡è«–åœ¨ dev æˆ– www éƒ½èƒ½è‡ªå‹•å°æ‡‰
          echo "VITE_API_URL=/api" >> .env
          
          # 3. Image URL
          # å‡è¨­åœ–ç‰‡ä¹Ÿæ˜¯é€éå¾Œç«¯ API æ‹¿ (ä¾‹å¦‚ /api/uploads/...)
          # é€™è£¡ä¹Ÿè¨­ç‚º /apiï¼Œæˆ–è€…è¨­ç‚ºç©ºå­—ä¸² (è¦–ä½ çš„åœ–ç‰‡è·¯å¾‘é‚è¼¯è€Œå®š)
          echo "VITE_IMAGE_URL=https://dev.taigiedu.com" >> .env
          
          # ---------------------------------------
          
          npm run build

      - name: Deploy to Server via SSH
        if: env.HAS_UPDATE == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 122
          
          source: "dist/*"
          
          # ğŸ”¥ã€é—œéµä¿®æ”¹ 2ã€‘éƒ¨ç½²è·¯å¾‘æ”¹åˆ°ç³»çµ±å…¬ç”¨ç›®éŒ„
          # ç¢ºä¿ä½ çš„ä¼ºæœå™¨å·²ç¶“åŸ·è¡Œé sudo chown p76131092 ...
          target: "/var/www/taigiedu/dist"
          
          strip_components: 1
