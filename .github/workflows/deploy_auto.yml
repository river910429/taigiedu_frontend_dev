name: Auto Sync and Deploy

on:
  # æ¯ 15 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '*/15 * * * *'
  # è®“ä½ ç¾åœ¨å¯ä»¥æ‰‹å‹•æŒ‰æŒ‰éˆ•æ¸¬è©¦
  workflow_dispatch:

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. åˆ‡æ›åˆ° develop åˆ†æ”¯
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: develop
          fetch-depth: 0
          # â†“â†“â†“ å‘Šè¨´å®ƒä¸è¦å„²å­˜é è¨­ Tokenï¼Œé€™æ¨£æˆ‘å€‘å¾Œé¢æ‰èƒ½è‡ªå·±ç”¨ Token
          persist-credentials: false

      # 2. è¨­å®š Git èº«åˆ†
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      # 3. å»æŠ“åŸå§‹ä½œè€…çš„æ›´æ–° (Sync) - é€™éƒ¨åˆ†ä¿æŒä¸è®Š
      - name: Sync from Upstream
        run: |
          # 1. æ‰‹å‹•å¹« origin è£ä¸Šä½ çš„è¬èƒ½ Token
          git remote set-url origin https://oauth2:${{ secrets.SYNC_TOKEN }}@github.com/river910429/taigiedu_frontend_dev.git
          
          # 2. è¨­å®š Upstream (å‰ç«¯åŸå§‹å°ˆæ¡ˆ)
          git remote add upstream https://oauth2:${{ secrets.SYNC_TOKEN }}@github.com/Taigiedu/taiwaneseOMG.git
          
          git fetch upstream
          
          UPSTREAM_HASH=$(git rev-parse upstream/develop)
          LOCAL_HASH=$(git rev-parse HEAD)
          
          if [ "$UPSTREAM_HASH" = "$LOCAL_HASH" ]; then
            echo "æ²’æœ‰æ–°ç‰ˆæœ¬ï¼Œè·³ééƒ¨ç½²ã€‚"
            echo "HAS_UPDATE=false" >> $GITHUB_ENV
          else
            echo "ç™¼ç¾æ–°ç‰ˆæœ¬ï¼æº–å‚™åŒæ­¥..."
            git reset --hard upstream/develop
            
            # é€™è£¡ç›´æ¥ push
            git push origin develop --force
            echo "HAS_UPDATE=true" >> $GITHUB_ENV
          fi

      # 4. åªæœ‰åœ¨æœ‰æ›´æ–° (æˆ–æ˜¯æ‰‹å‹•è§¸ç™¼) æ™‚æ‰æ‰“åŒ…éƒ¨ç½²
      - name: Setup Node.js
        if: env.HAS_UPDATE == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install and Build
        if: env.HAS_UPDATE == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          npm install
          
          # åœ¨æ‰“åŒ…å‰ï¼Œå¼·åˆ¶å»ºç«‹ .env æª”æ¡ˆ
          # é€™æ˜¯ç‚ºäº†ç¢ºä¿æ‰“åŒ…å‡ºä¾†çš„ç¨‹å¼ç¢¼æœƒå‘¼å« "/api" è€Œä¸æ˜¯åˆ¥çš„ç¶²å€
          echo "VITE_API_URL=/api" > .env
          echo "VITE_IMAGE_URL=/api" >> .env
          
          npm run build

      - name: Deploy to Server via SSH
        if: env.HAS_UPDATE == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2222
          
          source: "dist/*"
          
          # ğŸ”¥ã€é—œéµä¿®æ”¹ 2ã€‘éƒ¨ç½²è·¯å¾‘æ”¹åˆ°ç³»çµ±å…¬ç”¨ç›®éŒ„
          # ç¢ºä¿ä½ çš„ä¼ºæœå™¨å·²ç¶“åŸ·è¡Œé sudo chown p76131092 ...
          target: "/var/www/taigiedu/dist"
          
          strip_components: 1
